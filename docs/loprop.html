
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LoProp charges and polarisabilities &#8212; Computational Chemistry from  Laptop to HPC</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Polarizable embedding" href="pe.html" />
    <link rel="prev" title="RESP charges" href="resp.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Computational Chemistry from  Laptop to HPC</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Getting started
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Tutorials and workflows
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="uv-vis.html">
   UV/vis spectroscopies
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="uv-vis_calc.html">
     Spectrum calculation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="uv-vis_analysis.html">
     Spectrum analysis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="uv-vis_exercises.html">
     Exercises
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="xray.html">
   X-ray spectroscopies
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="xray_calc.html">
     Spectrum calculation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="xray_analysis.html">
     Spectrum analysis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="xray_aspects.html">
     Special aspects
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="xray_nonstandard.html">
     Non-standard calculations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="xray_rec.html">
     Recommendations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="xray_exercises.html">
     Exercises
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="vibrational.html">
   Vibrational spectroscopies
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="ir.html">
     IR spectroscopy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="raman.html">
     Raman spectroscopy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ir_raman_exercises.html">
     Exercises
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Electronic structure theory
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="elecstruct-general.html">
   General aspects
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="orbitals.html">
     Orbitals
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="basis.html">
     Basis sets
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="slater.html">
     Slater determinants
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="secondquant.html">
     Second quantization
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="wft.html">
   Wave function theory
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="wft-general.html">
     General aspects
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="hartree-fock.html">
     Hartree–Fock theory
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ci.html">
     Configuration interaction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="mp2.html">
     Møller–Plesset
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="mcscf.html">
     Multiconfigurational methods
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="wft-exercises.html">
     Exercises
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="dft.html">
   Density functional theory
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="hohenberg.html">
     Hohenberg–Kohn theorems
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="kohn-sham.html">
     Kohn–Sham method
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="kernel_integration.html">
     Kernel integration
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="dft_scf.html">
     SCF optimization of a closed-shell state
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Potential energy surfaces
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="pes-general.html">
   General aspects
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="coordinates.html">
     Choice of coordinates
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="gradients.html">
     Gradients
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="hessians.html">
     Hessians and vibrations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="forcefields.html">
     Force fields
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="structopt-overview.html">
   Molecular structure optimization
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="structopt.html">
     Optimization Methods
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="gsstructopt.html">
     Ground state structure optimization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="structopt-exercises.html">
     Exercises
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="tst.html">
   Transition-state theory
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
  <label for="toctree-checkbox-9">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="transition_state.html">
     Transition state geometry optimization
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="impes.html">
   Potential energy surfaces by interpolation
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="moldyn.html">
   Molecular dynamics
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
  <label for="toctree-checkbox-10">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="md_ffs.html">
     Force field parameterization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="md_setup.html">
     Ensembles and time integration
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="md_run.html">
     Running a simulation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="md_biased.html">
     Biased molecular dynamics
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Properties
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="response.html">
   Response theory
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
  <label for="toctree-checkbox-11">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="exact-response.html">
     Exact states
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ci-response.html">
     Configuration interaction and state-averaged MCSCF
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="scf-response.html">
     Time-Dependent Hartree–Fock
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="tddft.html">
     TDDFT
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="response_exercises.html">
     Exercises
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="adc.html">
   Algebraic-diagrammatic construction
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
  <label for="toctree-checkbox-12">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="adc-pp.html">
     Polarization propagator
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="adc-isr.html">
     Intermediate state representation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="adc-cvs.html">
     Core–valence separation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="adc-hpc.html">
     HPC-QC implementation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="adc-exercises.html">
     Exercises
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="excoupl.html">
   Exciton coupling model
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
  <label for="toctree-checkbox-13">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="excoupl_impl.html">
     Implementation of the exciton coupling model
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Environment
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="localprop.html">
   Localized properties
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/>
  <label for="toctree-checkbox-14">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="esp.html">
     ESP charges
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="resp.html">
     RESP charges
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     LoProp charges and polarisabilities
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="pe.html">
   Polarizable embedding
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Visualization
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="visual-orbitals.html">
   Structure and orbitals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="visual-densities.html">
   Reduced particle densities
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="visual-excited.html">
   Excited states
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  References
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="refs.html">
   References
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/docs/loprop.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/kthpanor/echem"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/kthpanor/echem/issues/new?title=Issue%20on%20page%20%2Fdocs/loprop.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/kthpanor/echem/master?urlpath=tree/docs/docs/loprop.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reference-loprop-calculations">
   Reference LoProp calculations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#loprop-transformation">
   LoProp transformation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#t0-atomic-orbital-rearrangement">
     T0: Atomic orbital rearrangement
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#t1-gramschmidt-orthogonalization-of-atomic-blocks">
     T1: Gram–Schmidt orthogonalization of atomic blocks
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#t2-lodwin-orthonormalization-of-occupied-and-virtual-blocks">
     T2: Lödwin orthonormalization of occupied and virtual blocks
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#t3-occupiedvirtual-projection">
     T3: Occupied–virtual projection
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#t4-lodwin-orthogonalizatio-of-virtual-blocks">
     T4: Lödwin  orthogonalizatio of virtual blocks
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#localization-of-first-order-properties">
   Localization of first-order properties
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#localized-charges">
     Localized charges
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#localized-dipole-moments">
     Localized dipole moments
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#localization-of-second-order-properties">
   Localization of  second-order properties
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#polarizabilities-from-response-functions">
     Polarizabilities from response functions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#polarizabilities-from-perturbed-density-matrices">
     Polarizabilities from perturbed density matrices
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#localized-polarizabilities">
     Localized polarizabilities
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>LoProp charges and polarisabilities</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reference-loprop-calculations">
   Reference LoProp calculations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#loprop-transformation">
   LoProp transformation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#t0-atomic-orbital-rearrangement">
     T0: Atomic orbital rearrangement
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#t1-gramschmidt-orthogonalization-of-atomic-blocks">
     T1: Gram–Schmidt orthogonalization of atomic blocks
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#t2-lodwin-orthonormalization-of-occupied-and-virtual-blocks">
     T2: Lödwin orthonormalization of occupied and virtual blocks
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#t3-occupiedvirtual-projection">
     T3: Occupied–virtual projection
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#t4-lodwin-orthogonalizatio-of-virtual-blocks">
     T4: Lödwin  orthogonalizatio of virtual blocks
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#localization-of-first-order-properties">
   Localization of first-order properties
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#localized-charges">
     Localized charges
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#localized-dipole-moments">
     Localized dipole moments
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#localization-of-second-order-properties">
   Localization of  second-order properties
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#polarizabilities-from-response-functions">
     Polarizabilities from response functions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#polarizabilities-from-perturbed-density-matrices">
     Polarizabilities from perturbed density matrices
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#localized-polarizabilities">
     Localized polarizabilities
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="loprop-charges-and-polarisabilities">
<span id="sec-loprop"></span><h1>LoProp charges and polarisabilities<a class="headerlink" href="#loprop-charges-and-polarisabilities" title="Permalink to this headline">¶</a></h1>
<p>The <em>localised properties</em> (LoProp) method <span id="id1">[<a class="reference internal" href="refs.html#id56">GLKarlstrom04</a>]</span> is a computationally inexpensive scheme that gives physically meaningful localised charges and polarisabilities that sum up to the corresponding molecular properties.</p>
<p>In this scheme, we classify atomic orbitals in the basis set to be either <em>occupied</em> or <em>virtual</em> based on the associated atomic electron configurations. The former category includes both fully and partially occupied atomic sub-shells.</p>
<p>We note that the family of atomic natiural orbital (ANO) basis sets is well suited for LoProp calculations as the basis functions are close to the orbitals of the atoms.</p>
<div class="section" id="reference-loprop-calculations">
<h2>Reference LoProp calculations<a class="headerlink" href="#reference-loprop-calculations" title="Permalink to this headline">¶</a></h2>
<p>As an example, let us consider hydrogen fluoride at the Hartree–Fock/6-31G level of theory. We first run a reference LoProp calculation with the built-in module in the VeloxChem program and will thereafter repeat the LoProp calculation step-by-step in the notebook.</p>
<div class="cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">veloxchem</span> <span class="k">as</span> <span class="nn">vlx</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="kn">import</span> <span class="n">inv</span>

<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">132</span><span class="p">)</span>

<span class="n">mol_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">F        0.00000000    0.00000000     -0.1733</span>
<span class="s2">H        0.00000000    0.00000000      1.5597</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">molecule</span> <span class="o">=</span> <span class="n">vlx</span><span class="o">.</span><span class="n">Molecule</span><span class="o">.</span><span class="n">read_str</span><span class="p">(</span><span class="n">mol_str</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;au&#39;</span><span class="p">)</span>
<span class="n">basis</span> <span class="o">=</span> <span class="n">vlx</span><span class="o">.</span><span class="n">MolecularBasis</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="s2">&quot;6-31G&quot;</span><span class="p">)</span>

<span class="n">natoms</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">number_of_atoms</span><span class="p">()</span>
<span class="n">norb</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">get_dimensions_of_basis</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>

<span class="c1"># SCF optimization</span>
<span class="n">scf_drv</span> <span class="o">=</span> <span class="n">vlx</span><span class="o">.</span><span class="n">ScfRestrictedDriver</span><span class="p">()</span>
<span class="n">scf_drv</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">basis</span><span class="p">)</span>

<span class="c1"># LoProp</span>
<span class="n">loprop_drv</span> <span class="o">=</span> <span class="n">vlx</span><span class="o">.</span><span class="n">LoPropDriver</span><span class="p">()</span>
<span class="n">loprop_out</span> <span class="o">=</span> <span class="n">loprop_drv</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">scf_drv</span><span class="o">.</span><span class="n">scf_tensors</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Localized charges (a.u.):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F: </span><span class="si">{</span><span class="n">loprop_out</span><span class="p">[</span><span class="s1">&#39;localized_charges&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="si">:</span><span class="s2"> .4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;H: </span><span class="si">{</span><span class="n">loprop_out</span><span class="p">[</span><span class="s1">&#39;localized_charges&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="si">:</span><span class="s2"> .4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Localized polarizabilities (a.u.):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     xx      xy      xz      yy      yz      zz&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F: </span><span class="si">{</span><span class="n">loprop_out</span><span class="p">[</span><span class="s1">&#39;localized_polarizabilities&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;H: </span><span class="si">{</span><span class="n">loprop_out</span><span class="p">[</span><span class="s1">&#39;localized_polarizabilities&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Localized charges (a.u.):
F: -0.1191
H:  0.1191

Localized polarizabilities (a.u.):
     xx      xy      xz      yy      yz      zz
F: [ 0.4371  0.     -0.      0.4371 -0.      1.917 ]
H: [ 0.226  -0.     -0.      0.226  -0.      1.9525]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="loprop-transformation">
<h2>LoProp transformation<a class="headerlink" href="#loprop-transformation" title="Permalink to this headline">¶</a></h2>
<p>A LoProp transformation is performed of the atomic orbitals to obtain an orthonormal set of basis functions</p>
<div class="math notranslate nohighlight">
\[
| \boldsymbol{\chi}^\mathrm{L} \rangle = | \boldsymbol{\chi} \rangle \mathbf{T}
\]</div>
<p>This transformation is decomposed into five steps</p>
<div class="math notranslate nohighlight">
\[ 
\mathbf{T} = \mathbf{T}_0 \times \mathbf{T}_1 \times \mathbf{T}_2 \times \mathbf{T}_3  \times \mathbf{T}_4
\]</div>
<ul class="simple">
<li><p>T0: Reordering of atomic orbitals</p></li>
<li><p>T1: Gram–Schmidt orthonormalisation for each atom block</p></li>
<li><p>T2: Lödwin orthonomalisation on occupied and virtual</p></li>
<li><p>T3: occupied to virtual projection</p></li>
<li><p>T4: Lödwin virtual</p></li>
</ul>
<p>with the overall aim to retain the atomic character of the occupied orbitals.</p>
<p>We start with the overlap matrix, <span class="math notranslate nohighlight">\(S\)</span>, in the original AO basis:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">S</span> <span class="o">=</span> <span class="n">scf_drv</span><span class="o">.</span><span class="n">scf_tensors</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[1.     0.2443 0.1716 0.0341 0.0601 0.     0.     0.     0.     0.     0.    ]
 [0.2443 1.     0.7635 0.2275 0.3321 0.     0.     0.     0.     0.     0.    ]
 [0.1716 0.7635 1.     0.4306 0.6374 0.     0.     0.     0.     0.     0.    ]
 [0.0341 0.2275 0.4306 1.     0.6583 0.     0.     0.2409 0.5971 0.     0.    ]
 [0.0601 0.3321 0.6374 0.6583 1.     0.     0.     0.1098 0.4105 0.     0.    ]
 [0.     0.     0.     0.     0.     1.     0.4995 0.     0.     0.     0.    ]
 [0.     0.     0.     0.     0.     0.4995 1.     0.     0.     0.     0.    ]
 [0.     0.     0.     0.2409 0.1098 0.     0.     1.     0.4995 0.     0.    ]
 [0.     0.     0.     0.5971 0.4105 0.     0.     0.4995 1.     0.     0.    ]
 [0.     0.     0.     0.     0.     0.     0.     0.     0.     1.     0.4995]
 [0.     0.     0.     0.     0.     0.     0.     0.     0.     0.4995 1.    ]]
</pre></div>
</div>
</div>
</div>
<div class="section" id="t0-atomic-orbital-rearrangement">
<h3>T0: Atomic orbital rearrangement<a class="headerlink" href="#t0-atomic-orbital-rearrangement" title="Permalink to this headline">¶</a></h3>
<div class="figure align-center" id="t0-transformation">
<img alt="../_images/loprop_T0.svg" src="../_images/loprop_T0.svg" /><p class="caption"><span class="caption-number">Fig. 32 </span><span class="caption-text">Re-arranging atomic orbitals.</span><a class="headerlink" href="#t0-transformation" title="Permalink to this image">¶</a></p>
</div>
<p>For hydrogen floride with the user defined order of atoms (F before H), the AOs are arranged as follow:</p>
<p><font color='red'><span class="math notranslate nohighlight">\(\chi_{1s}^{F}\)</span>, <span class="math notranslate nohighlight">\(\chi_{2s}^{F}\)</span></font>,  <span class="math notranslate nohighlight">\(\chi_{3s}^{F}\)</span>
<font color='red'><span class="math notranslate nohighlight">\(\chi_{1s}^{H}\)</span></font>, <span class="math notranslate nohighlight">\(\chi_{2s}^{H}\)</span>
<font color='red'><span class="math notranslate nohighlight">\(\chi_{1py}^{F}\)</span></font>, <span class="math notranslate nohighlight">\(\chi_{2py}^{F}\)</span>,
<font color='red'><span class="math notranslate nohighlight">\(\chi_{1pz}^{F}\)</span></font>, <span class="math notranslate nohighlight">\(\chi_{2pz}^{F}\)</span>,
<font color='red'><span class="math notranslate nohighlight">\(\chi_{1px}^{F}\)</span></font>, <span class="math notranslate nohighlight">\(\chi_{2px}^{F}\)</span></p>
<p>where orbitals classified as occupied are high-lighted in red. The <span class="math notranslate nohighlight">\(T_0\)</span> transformation re-arranges the orbitals as follows:</p>
<p><font color='red'><span class="math notranslate nohighlight">\(\chi_{1s}^{F}\)</span>, <span class="math notranslate nohighlight">\(\chi_{2s}^{F}\)</span></font>, <span class="math notranslate nohighlight">\(\chi_{3s}^{F}\)</span>,
<font color='red'><span class="math notranslate nohighlight">\(\chi_{1px}^{F}\)</span>, <span class="math notranslate nohighlight">\(\chi_{1py}^{F}\)</span>,<span class="math notranslate nohighlight">\(\chi_{1pz}^{F}\)</span></font>,
<span class="math notranslate nohighlight">\(\chi_{2px}^{F}\)</span>, <span class="math notranslate nohighlight">\(\chi_{2py}^{F}\)</span>,<span class="math notranslate nohighlight">\(\chi_{2pz}^{F}\)</span>,  <font color='red'><span class="math notranslate nohighlight">\(\chi_{1s}^{H}\)</span></font>,
<span class="math notranslate nohighlight">\(\chi_{2s}^{H}\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rearranged_indices</span><span class="o">=</span><span class="p">[]</span>

<span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>
    <span class="n">indices</span><span class="p">,</span> <span class="n">angmoms</span> <span class="o">=</span> <span class="n">vlx</span><span class="o">.</span><span class="n">get_basis_function_indices_for_atom</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span>
    <span class="n">rearranged_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
    
<span class="n">rearranged_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">rearranged_indices</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Rearranged AO indices：&#39;</span><span class="p">,</span> <span class="n">rearranged_indices</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Rearranged AO indices： [ 0  1  2  9  5  7 10  6  8  3  4]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">))</span>

<span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rearranged_indices</span><span class="p">):</span>
    <span class="n">T0</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">S0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ba,bc,cd-&gt;ad&#39;</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">T0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">S0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[1.     0.2443 0.1716 0.     0.     0.     0.     0.     0.     0.0341 0.0601]
 [0.2443 1.     0.7635 0.     0.     0.     0.     0.     0.     0.2275 0.3321]
 [0.1716 0.7635 1.     0.     0.     0.     0.     0.     0.     0.4306 0.6374]
 [0.     0.     0.     1.     0.     0.     0.4995 0.     0.     0.     0.    ]
 [0.     0.     0.     0.     1.     0.     0.     0.4995 0.     0.     0.    ]
 [0.     0.     0.     0.     0.     1.     0.     0.     0.4995 0.2409 0.1098]
 [0.     0.     0.     0.4995 0.     0.     1.     0.     0.     0.     0.    ]
 [0.     0.     0.     0.     0.4995 0.     0.     1.     0.     0.     0.    ]
 [0.     0.     0.     0.     0.     0.4995 0.     0.     1.     0.5971 0.4105]
 [0.0341 0.2275 0.4306 0.     0.     0.2409 0.     0.     0.5971 1.     0.6583]
 [0.0601 0.3321 0.6374 0.     0.     0.1098 0.     0.     0.4105 0.6583 1.    ]]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="t1-gramschmidt-orthogonalization-of-atomic-blocks">
<h3>T1: Gram–Schmidt orthogonalization of atomic blocks<a class="headerlink" href="#t1-gramschmidt-orthogonalization-of-atomic-blocks" title="Permalink to this headline">¶</a></h3>
<div class="figure align-center" id="t1-transformation">
<img alt="../_images/loprop_T1.svg" src="../_images/loprop_T1.svg" /><p class="caption"><span class="caption-number">Fig. 33 </span><span class="caption-text">Diagonalization of the atomic blocks.</span><a class="headerlink" href="#t1-transformation" title="Permalink to this image">¶</a></p>
</div>
<p>Orthonormality in the atomic blocks of the overlap matrix is reached with a Gram–Schmidt orthogonalization, or equivalently with a Cholesky factorization. Using Gram-Schmidt orthogonalization ensures that the atomic subspace of the occupied basis functions is left intact. We have</p>
<p><span class="math notranslate nohighlight">\(S_0 = L L^T\)</span></p>
<p>where <span class="math notranslate nohighlight">\(L\)</span> is a lower triangular matrix. We get</p>
<p><span class="math notranslate nohighlight">\(I = L^{-1} S_0 [L^T]^{-1}\)</span></p>
<p>and identify</p>
<p><span class="math notranslate nohighlight">\(T_1 = [L^T]^{-1}\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">norb</span><span class="p">,</span><span class="n">norb</span><span class="p">))</span>

<span class="n">norb_per_atom</span><span class="p">,</span> <span class="n">indices_occ</span><span class="p">,</span> <span class="n">indices_virt</span> <span class="o">=</span> <span class="n">loprop_drv</span><span class="o">.</span><span class="n">get_ao_indices</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">basis</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Occupied orbitals:&#39;</span><span class="p">,</span> <span class="n">indices_occ</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Virtual orbitals:&#39;</span><span class="p">,</span> <span class="n">indices_virt</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">ri</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>

    <span class="n">rf</span> <span class="o">=</span> <span class="n">ri</span> <span class="o">+</span> <span class="n">norb_per_atom</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>

    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">S0</span><span class="p">[</span><span class="n">ri</span><span class="p">:</span><span class="n">rf</span><span class="p">,</span> <span class="n">ri</span><span class="p">:</span><span class="n">rf</span><span class="p">])</span>
    <span class="n">T1</span><span class="p">[</span><span class="n">ri</span><span class="p">:</span><span class="n">rf</span><span class="p">,</span> <span class="n">ri</span><span class="p">:</span><span class="n">rf</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">ri</span> <span class="o">+=</span> <span class="n">norb_per_atom</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>

<span class="n">S1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ba,bc,cd-&gt;ad&#39;</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">S0</span><span class="p">,</span> <span class="n">T1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">S1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Occupied orbitals: [0, 1, 3, 4, 5, 9]
Virtual orbitals: [2, 6, 7, 8, 10] 

[[ 1.     -0.      0.      0.      0.      0.      0.      0.      0.      0.0341  0.0501]
 [ 0.      1.     -0.      0.      0.      0.      0.      0.      0.      0.226   0.2372]
 [-0.      0.      1.      0.      0.      0.      0.      0.      0.      0.3975  0.4416]
 [ 0.      0.      0.      1.      0.      0.      0.      0.      0.      0.      0.    ]
 [ 0.      0.      0.      0.      1.      0.      0.      0.      0.      0.      0.    ]
 [ 0.      0.      0.      0.      0.      1.      0.      0.      0.      0.2409 -0.0647]
 [ 0.      0.      0.      0.      0.      0.      1.      0.      0.      0.      0.    ]
 [ 0.      0.      0.      0.      0.      0.      0.      1.      0.      0.      0.    ]
 [ 0.      0.      0.      0.      0.      0.      0.      0.      1.      0.5504  0.0641]
 [ 0.0341  0.226   0.3975  0.      0.      0.2409  0.      0.      0.5504  1.     -0.    ]
 [ 0.0501  0.2372  0.4416  0.      0.     -0.0647  0.      0.      0.0641 -0.      1.    ]]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="t2-lodwin-orthonormalization-of-occupied-and-virtual-blocks">
<h3>T2: Lödwin orthonormalization of occupied and virtual blocks<a class="headerlink" href="#t2-lodwin-orthonormalization-of-occupied-and-virtual-blocks" title="Permalink to this headline">¶</a></h3>
<div class="figure align-center" id="t2-transformation">
<img alt="../_images/loprop_T2.svg" src="../_images/loprop_T2.svg" /><p class="caption"><span class="caption-number">Fig. 34 </span><span class="caption-text">Diagonalization of the occupied and virtual blocks.</span><a class="headerlink" href="#t2-transformation" title="Permalink to this image">¶</a></p>
</div>
<p>The use of Löwdin orthonormalization ensures that the orbitals in the occupied and virtual subspaces are made orthonormal with a minimal modification as compared to the original atomic orbitals.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">))</span>

<span class="n">S1_oo</span> <span class="o">=</span> <span class="n">S1</span><span class="p">[</span><span class="n">indices_occ</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">indices_occ</span><span class="p">]</span>
<span class="n">T2_oo</span> <span class="o">=</span> <span class="n">loprop_drv</span><span class="o">.</span><span class="n">lowdin_orthonormalize</span><span class="p">(</span><span class="n">S1_oo</span><span class="p">)</span>

<span class="n">nocc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices_occ</span><span class="p">)</span>
<span class="n">nvirt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices_virt</span><span class="p">)</span>

<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">):</span>
        <span class="n">T2</span><span class="p">[</span><span class="n">indices_occ</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">indices_occ</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span> <span class="o">=</span> <span class="n">T2_oo</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>

<span class="n">S1_vv</span> <span class="o">=</span> <span class="n">S1</span><span class="p">[</span><span class="n">indices_virt</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">indices_virt</span><span class="p">]</span>
<span class="n">T2_vv</span> <span class="o">=</span> <span class="n">loprop_drv</span><span class="o">.</span><span class="n">lowdin_orthonormalize</span><span class="p">(</span><span class="n">S1_vv</span><span class="p">)</span>

<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvirt</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvirt</span><span class="p">):</span>
        <span class="n">T2</span><span class="p">[</span><span class="n">indices_virt</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">indices_virt</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span> <span class="o">=</span> <span class="n">T2_vv</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>
        
<span class="n">S2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ba,bc,cd-&gt;ad&#39;</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">S1</span><span class="p">,</span> <span class="n">T2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">S2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[ 1.     -0.     -0.0209 -0.      0.     -0.      0.      0.     -0.0121  0.      0.0573]
 [-0.      1.     -0.1143  0.     -0.     -0.      0.      0.     -0.0765 -0.      0.2767]
 [-0.0209 -0.1143  1.      0.      0.     -0.0414  0.      0.     -0.      0.4636  0.    ]
 [-0.      0.      0.      1.      0.     -0.      0.      0.      0.      0.     -0.    ]
 [ 0.     -0.      0.      0.      1.      0.      0.      0.      0.      0.     -0.    ]
 [-0.     -0.     -0.0414 -0.      0.      1.      0.      0.     -0.0698 -0.     -0.0505]
 [ 0.      0.      0.      0.      0.      0.      1.      0.      0.      0.      0.    ]
 [ 0.      0.      0.      0.      0.      0.      0.      1.      0.      0.      0.    ]
 [-0.0121 -0.0765 -0.      0.      0.     -0.0698  0.      0.      1.      0.5822  0.    ]
 [-0.     -0.      0.4636  0.      0.     -0.      0.      0.      0.5822  1.     -0.1497]
 [ 0.0573  0.2767  0.     -0.     -0.     -0.0505  0.      0.      0.     -0.1497  1.    ]]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="t3-occupiedvirtual-projection">
<h3>T3: Occupied–virtual projection<a class="headerlink" href="#t3-occupiedvirtual-projection" title="Permalink to this headline">¶</a></h3>
<div class="figure align-center" id="t3-transformation">
<img alt="../_images/loprop_T3.svg" src="../_images/loprop_T3.svg" /><p class="caption"><span class="caption-number">Fig. 35 </span><span class="caption-text">Projecting out the occupied space from the virtual.</span><a class="headerlink" href="#t3-transformation" title="Permalink to this image">¶</a></p>
</div>
<p>Components from the occipied subspace are projected out of the virtual subspace by means of Gram–Schmidt orthonormalizaton.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">norb</span><span class="p">)</span>

<span class="n">S2_ov</span> <span class="o">=</span> <span class="n">S2</span><span class="p">[</span><span class="n">indices_occ</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">indices_virt</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">index_occ</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices_occ</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">index_virt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices_virt</span><span class="p">):</span>
        <span class="n">T3</span><span class="p">[</span><span class="n">index_occ</span><span class="p">,</span> <span class="n">index_virt</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">S2_ov</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

<span class="n">S3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ba,bc,cd-&gt;ad&#39;</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">S2</span><span class="p">,</span> <span class="n">T3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">S3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[ 1.     -0.     -0.     -0.      0.     -0.      0.      0.     -0.      0.      0.    ]
 [-0.      1.      0.      0.     -0.     -0.      0.      0.      0.     -0.     -0.    ]
 [-0.      0.      0.7698 -0.     -0.      0.      0.      0.     -0.2818  0.      0.1001]
 [-0.      0.     -0.      1.      0.     -0.      0.      0.     -0.      0.      0.    ]
 [ 0.     -0.     -0.      0.      1.      0.      0.      0.     -0.      0.      0.    ]
 [-0.     -0.      0.     -0.      0.      1.      0.      0.      0.     -0.      0.    ]
 [ 0.      0.      0.      0.      0.      0.      1.      0.      0.      0.      0.    ]
 [ 0.      0.      0.      0.      0.      0.      0.      1.      0.      0.      0.    ]
 [-0.      0.     -0.2818 -0.     -0.      0.      0.      0.      0.6502  0.      0.1055]
 [-0.     -0.      0.      0.      0.     -0.      0.      0.      0.      1.     -0.    ]
 [ 0.     -0.      0.1001  0.      0.      0.      0.      0.      0.1055 -0.      0.8952]]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="t4-lodwin-orthogonalizatio-of-virtual-blocks">
<h3>T4: Lödwin  orthogonalizatio of virtual blocks<a class="headerlink" href="#t4-lodwin-orthogonalizatio-of-virtual-blocks" title="Permalink to this headline">¶</a></h3>
<div class="figure align-center" id="t4-transformation">
<img alt="../_images/loprop_T4.svg" src="../_images/loprop_T4.svg" /><p class="caption"><span class="caption-number">Fig. 36 </span><span class="caption-text">Diagonalization the virtual subspace.</span><a class="headerlink" href="#t4-transformation" title="Permalink to this image">¶</a></p>
</div>
<p>The virtual subspace is Löwdin orthonmalised.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">norb</span><span class="p">)</span>

<span class="n">S3_vv</span> <span class="o">=</span> <span class="n">S3</span><span class="p">[</span><span class="n">indices_virt</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">indices_virt</span><span class="p">]</span>
<span class="n">T4_vv</span> <span class="o">=</span> <span class="n">loprop_drv</span><span class="o">.</span><span class="n">lowdin_orthonormalize</span><span class="p">(</span><span class="n">S3_vv</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">index_virt1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices_virt</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">index_virt2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices_virt</span><span class="p">):</span>
        <span class="n">T4</span><span class="p">[</span><span class="n">index_virt1</span><span class="p">,</span> <span class="n">index_virt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">T4_vv</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
        
<span class="n">S4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ba,bc,cd-&gt;ad&#39;</span><span class="p">,</span> <span class="n">T4</span><span class="p">,</span> <span class="n">S3</span><span class="p">,</span> <span class="n">T4</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">S4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[ 1. -0. -0. -0.  0. -0. -0.  0. -0.  0.  0.]
 [-0.  1.  0.  0. -0. -0.  0.  0.  0. -0. -0.]
 [-0.  0.  1. -0. -0.  0.  0. -0.  0.  0.  0.]
 [-0.  0. -0.  1.  0. -0. -0. -0. -0.  0.  0.]
 [ 0. -0. -0.  0.  1.  0. -0.  0. -0.  0.  0.]
 [-0. -0.  0. -0.  0.  1.  0.  0.  0. -0.  0.]
 [-0.  0.  0. -0. -0.  0.  1.  0.  0.  0. -0.]
 [ 0. -0. -0. -0.  0.  0.  0.  1.  0.  0.  0.]
 [-0.  0.  0. -0. -0.  0.  0.  0.  1.  0.  0.]
 [-0. -0.  0.  0.  0. -0.  0.  0.  0.  1. -0.]
 [ 0. -0.  0.  0.  0.  0. -0.  0.  0. -0.  1.]]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<p>The complete LoProp transformation matrix is formed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ab,bc,cd,de,ef-&gt;af&#39;</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">,</span> <span class="n">T4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The orbitals in the LoProp basis are atomic in character:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   F 1s    F 2s    F 2px   F 2py   F 2pz   H 1s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">49</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">T</span><span class="p">[:,</span><span class="n">indices_occ</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   F 1s    F 2s    F 2px   F 2py   F 2pz   H 1s
 -------------------------------------------------
[[ 0.9997 -0.2541 -0.      0.     -0.0022  0.0123]
 [ 0.0032  1.0527 -0.     -0.      0.0229 -0.1253]
 [ 0.      0.      0.      0.      0.      0.    ]
 [-0.0183 -0.1215  0.      0.     -0.1295  1.045 ]
 [ 0.      0.      0.      0.      0.      0.    ]
 [ 0.     -0.      0.      1.      0.      0.    ]
 [ 0.      0.      0.      0.      0.      0.    ]
 [ 0.0033  0.0222 -0.      0.      1.0237 -0.1295]
 [ 0.      0.      0.      0.      0.      0.    ]
 [-0.      0.      1.      0.     -0.      0.    ]
 [ 0.      0.      0.      0.      0.      0.    ]]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="localization-of-first-order-properties">
<h2>Localization of first-order properties<a class="headerlink" href="#localization-of-first-order-properties" title="Permalink to this headline">¶</a></h2>
<p>A molecular first-order property associated with an expctation value of a one-electron operator can be expressed as</p>
<div class="math notranslate nohighlight">
\[
\langle \hat{\Omega} \rangle = \mathrm{tr}
\big[
\Omega D
\big]
\]</div>
<p>where <span class="math notranslate nohighlight">\(\Omega\)</span> and <span class="math notranslate nohighlight">\(D\)</span> are the property and one-particle reduced density matrices in original AO basis, respectively. This trace can equally well be evaluated in the LoProp basis after transforming the matrices.</p>
<p>From the LCAO expansions of MOs</p>
<div class="math notranslate nohighlight">
\[
| \boldsymbol{\phi} \rangle = | \boldsymbol{\chi} \rangle C
= | \boldsymbol{\chi}^\mathrm{L} \rangle T^{-1} C
\]</div>
<p>we identify</p>
<div class="math notranslate nohighlight">
\[
C^\mathrm{L} = T^{-1} C
\]</div>
<p>and consequently</p>
<div class="math notranslate nohighlight">
\[
D^\mathrm{L} = T^{-1} D \, [T^\dagger]^{-1} = T^{-1} D \, [T^{-1}]^\dagger
\]</div>
<p>The transformation of property matrices is straightforwardly shown to be given by</p>
<div class="math notranslate nohighlight">
\[
\Omega^\mathrm{L} = T^\dagger \Omega T
\]</div>
<p>We arrive at an decomposition of first-order properties in atomic contributions according to</p>
<div class="math notranslate nohighlight">
\[
\langle \hat{\Omega} \rangle = 
\sum_{A}
\Omega^\mathrm{L}_{A}; \qquad
\Omega^\mathrm{L}_{A} = \sum_{B}
\Omega^\mathrm{L}_{AB}; \qquad
\Omega^\mathrm{L}_{AB} =
\sum_{\alpha \in A}
\sum_{\beta \in B}
\Omega^\mathrm{L}_{\alpha\beta} D^\mathrm{L}_{\beta\alpha}
\]</div>
<p>where <span class="math notranslate nohighlight">\(A\)</span> and <span class="math notranslate nohighlight">\(B\)</span> are atom indices and <span class="math notranslate nohighlight">\(\alpha\)</span> and <span class="math notranslate nohighlight">\(\beta\)</span> are atomic orbital indices.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">atomic_property</span><span class="p">(</span><span class="n">Omega</span><span class="p">,</span> <span class="n">D</span><span class="p">):</span>
    
    <span class="n">Omega_AB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">natoms</span><span class="p">,</span> <span class="n">natoms</span><span class="p">))</span>

    <span class="n">Omega_L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ba,bc,cd-&gt;ad&#39;</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Omega</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
    <span class="n">D_L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ab,bc,dc-&gt;ad&#39;</span><span class="p">,</span> <span class="n">inv</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="n">D</span><span class="p">,</span> <span class="n">inv</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
    
    <span class="n">idx_A</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">A</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>

        <span class="n">idx_B</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">B</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>
            
            <span class="n">P</span> <span class="o">=</span> <span class="n">Omega_L</span><span class="p">[</span><span class="n">idx_A</span> <span class="p">:</span> <span class="n">idx_A</span> <span class="o">+</span> <span class="n">norb_per_atom</span><span class="p">[</span><span class="n">A</span><span class="p">],</span> <span class="n">idx_B</span> <span class="p">:</span> <span class="n">idx_B</span> <span class="o">+</span> <span class="n">norb_per_atom</span><span class="p">[</span><span class="n">B</span><span class="p">]]</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">D_L</span><span class="p">[</span><span class="n">idx_A</span> <span class="p">:</span> <span class="n">idx_A</span> <span class="o">+</span> <span class="n">norb_per_atom</span><span class="p">[</span><span class="n">A</span><span class="p">],</span> <span class="n">idx_B</span> <span class="p">:</span> <span class="n">idx_B</span> <span class="o">+</span> <span class="n">norb_per_atom</span><span class="p">[</span><span class="n">B</span><span class="p">]]</span>
        
            <span class="n">Omega_AB</span><span class="p">[</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>
                    
            <span class="n">idx_B</span> <span class="o">+=</span> <span class="n">norb_per_atom</span><span class="p">[</span><span class="n">B</span><span class="p">]</span>
            
        <span class="n">idx_A</span> <span class="o">+=</span> <span class="n">norb_per_atom</span><span class="p">[</span><span class="n">A</span><span class="p">]</span>
        
    <span class="k">return</span> <span class="n">Omega_AB</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="localized-charges">
<h3>Localized charges<a class="headerlink" href="#localized-charges" title="Permalink to this headline">¶</a></h3>
<p>The total electronic charge is equal to</p>
<div class="math notranslate nohighlight">
\[
Q = -e \, 
\mathrm{tr} \big[ S D \big]
\]</div>
<p>The atomic charges are obtained from the partial summations over atomic orbitals in the orthonormal LoProp basis</p>
<div class="math notranslate nohighlight">
\[
Q_A = 
- e
\sum_{\alpha \in A}
D^\mathrm{L}_{\alpha\alpha}
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># atomic numbers and therefore nuclear charge in atomic units</span>
<span class="n">Z_A</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">elem_ids_to_numpy</span><span class="p">()</span>
<span class="n">D</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">scf_drv</span><span class="o">.</span><span class="n">scf_tensors</span><span class="p">[</span><span class="s1">&#39;D_alpha&#39;</span><span class="p">]</span>

<span class="n">Q_A</span> <span class="o">=</span> <span class="o">-</span> <span class="n">atomic_property</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">Q_A</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total electronic charge: </span><span class="si">{</span><span class="n">Q</span> <span class="si">:</span><span class="s2"> .4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Localized atomic charges: </span><span class="si">{</span><span class="n">Q_A</span> <span class="o">+</span> <span class="n">Z_A</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total electronic charge: -10.0000
Localized atomic charges: [-0.1191  0.1191]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="localized-dipole-moments">
<h3>Localized dipole moments<a class="headerlink" href="#localized-dipole-moments" title="Permalink to this headline">¶</a></h3>
<p>With <span class="math notranslate nohighlight">\(\hat{\Omega} =  -e \, \hat{z}\)</span>, the associated property is the electronic dipole moment along the bond axis.</p>
<p>The total molecular electronic dipole moment is equal to</p>
<div class="math notranslate nohighlight">
\[
\langle \hat{\mu} \rangle = \mathrm{tr} \big[ \mu D \big]
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dipole_drv</span> <span class="o">=</span> <span class="n">vlx</span><span class="o">.</span><span class="n">ElectricDipoleIntegralsDriver</span><span class="p">()</span>
<span class="n">dipole_mats</span> <span class="o">=</span> <span class="n">dipole_drv</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">basis</span><span class="p">)</span>

<span class="n">mu</span> <span class="o">=</span> <span class="o">-</span> <span class="n">dipole_mats</span><span class="o">.</span><span class="n">z_to_numpy</span><span class="p">()</span>

<span class="n">mu_AB</span> <span class="o">=</span> <span class="n">atomic_property</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total dipole moment: </span><span class="si">{</span><span class="n">mu_AB</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="si">:</span><span class="s1"> .4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">mu_AB:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">mu_AB</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total dipole moment:  0.9033

mu_AB:
 [[ 2.0947  0.1471]
 [ 0.1471 -1.4855]]
</pre></div>
</div>
</div>
</div>
<p>We note that the nuclear contribution to the total molecular dipole moment here vanished as due to our choice of placing the origin of the coordinate system at the center of nuclear charge.</p>
<p>The local dipole moment is origin dependent and local origins are therefore used.</p>
<div class="figure align-center" id="local-origin">
<img alt="../_images/loprop_local_origin.svg" src="../_images/loprop_local_origin.svg" /><p class="caption"><span class="caption-number">Fig. 37 </span><span class="caption-text">Bond midpoint coordinates.</span><a class="headerlink" href="#local-origin" title="Permalink to this image">¶</a></p>
</div>
<p>We introduce</p>
<div class="math notranslate nohighlight">
\[
\boldsymbol{R}_{AB} = \frac{\boldsymbol{R}_{A} + \boldsymbol{R}_{B}}{2}
\]</div>
<p>as the bond midpoint coordinate. When <span class="math notranslate nohighlight">\(\boldsymbol{R}_{A} = \boldsymbol{R}_{B}\)</span>, it reduces to the atomic coordinate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">natoms</span><span class="p">,</span> <span class="n">natoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="n">coords</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">()</span>

<span class="k">for</span> <span class="n">A</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">B</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>
    
        <span class="n">R</span><span class="p">[</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">A</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">coords</span><span class="p">[</span><span class="n">B</span><span class="p">,:])</span> <span class="o">/</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<p>With use of local origins, we define a gauge-orgin independent dipole moment</p>
<div class="math notranslate nohighlight">
\[
\boldsymbol{\mu}^\mathrm{L}_{(AB)} =
-e 
\sum_{\alpha \in A}
\sum_{\beta \in B}
\langle \chi^\mathrm{L}_\alpha | (\hat{\boldsymbol{r}} - \boldsymbol{R}_{AB}) | \chi^\mathrm{L}_\beta \rangle D^\mathrm{L}_{\beta\alpha}
\]</div>
<p>It can be determined from the relation</p>
<div class="math notranslate nohighlight">
\[
\boldsymbol{\mu}^\mathrm{L}_{(AB)} =
\boldsymbol{\mu}^\mathrm{L}_{AB} - Q_A \boldsymbol{R}_{A} \delta_{AB}
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;mu_(AB):</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">mu_AB</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Q_A</span><span class="p">)</span> <span class="o">*</span> <span class="n">R</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mu_(AB):
 [[ 0.5144  0.1471]
 [ 0.1471 -0.1116]]
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="localization-of-second-order-properties">
<h2>Localization of  second-order properties<a class="headerlink" href="#localization-of-second-order-properties" title="Permalink to this headline">¶</a></h2>
<div class="section" id="polarizabilities-from-response-functions">
<h3>Polarizabilities from response functions<a class="headerlink" href="#polarizabilities-from-response-functions" title="Permalink to this headline">¶</a></h3>
<p>The components of the electric-dipole polarizability tensor ia calculated from the linear response function</p>
<div class="math notranslate nohighlight">
\[
\alpha(-\omega;\omega) = -
\langle\langle \hat{\mu}; \hat{\mu} \rangle\rangle_\omega =
-{\mu^{[1]}}^\dagger N(\omega)
\]</div>
<p>where we have omitted the Cartesian tensor indices associated with the components of the dipole operators. For illustration, we will focus on the <span class="math notranslate nohighlight">\(zz\)</span>-component in the static limit, <span class="math notranslate nohighlight">\(\omega = 0\)</span>.</p>
<p>The strucure of the property gradient is</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\mu^{[1]} =
\begin{pmatrix}
g \\
-g^* \\
\end{pmatrix}
\end{split}\]</div>
<p>where the elements of <span class="math notranslate nohighlight">\(g\)</span> refer to pairs of occupied–virtual orbital indices. With use of normalized, spin-adapted, electron excitation operators</p>
<div class="math notranslate nohighlight">
\[
\hat{E}_{si}^\dagger = \frac{1}{\sqrt{2}}
\big(
\hat{a}^\dagger_{s, \alpha} \hat{a}_{i, \alpha} +
\hat{a}^\dagger_{s, \beta} \hat{a}_{i, \beta} 
\big)
\]</div>
<p>we get</p>
<div class="math notranslate nohighlight">
\[
g_{si} = 
\langle 0 | \big[ \hat{E}_{si}, \hat{\mu} \big] | 0 \rangle =
\sqrt{2} \mu_{si}
\]</div>
<p>The response vector <span class="math notranslate nohighlight">\(N(\omega)\)</span> is introduced as the solution vector to the linear response equation</p>
<div class="math notranslate nohighlight">
\[
N(\omega) =
\Big(
E^{[2]} - \hbar \omega S^{[2]}
\Big)^{-1}
\mu^{[1]}
\]</div>
<p>The structure of the response vectors is</p>
<div class="math notranslate nohighlight">
\[\begin{split}
N(\omega) =
\begin{pmatrix}
Z \\
-Y^* \\
\end{pmatrix}
\end{split}\]</div>
<p>and in the static limit, we have <span class="math notranslate nohighlight">\(Y = Z\)</span>.</p>
<div class="cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lrs_drv</span> <span class="o">=</span> <span class="n">vlx</span><span class="o">.</span><span class="n">LinearResponseSolver</span><span class="p">()</span>
<span class="n">lrs_out</span> <span class="o">=</span> <span class="n">lrs_drv</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">scf_drv</span><span class="o">.</span><span class="n">scf_tensors</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span> <span class="n">lrs_out</span><span class="p">[</span><span class="s1">&#39;response_functions&#39;</span><span class="p">][(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Molecular polarizability (zz-component): </span><span class="si">{</span><span class="n">alpha</span> <span class="si">:</span><span class="s2"> .4f</span><span class="si">}</span><span class="s2"> a.u.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Molecular polarizability (zz-component):  3.8695 a.u.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="polarizabilities-from-perturbed-density-matrices">
<h3>Polarizabilities from perturbed density matrices<a class="headerlink" href="#polarizabilities-from-perturbed-density-matrices" title="Permalink to this headline">¶</a></h3>
<p>The upper and lower parts of the response vector can be unpacked into the occupied–virtual (ov) and virtual–occupied (vo) blocks of associate MO matrices according to</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\kappa =
\begin{pmatrix}
0 &amp; Z \\
Y^* &amp; 0 \\
\end{pmatrix}
\end{split}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vec2mat</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">norb</span><span class="p">):</span>
    
    <span class="n">n</span> <span class="o">=</span> <span class="n">nocc</span> <span class="o">*</span> <span class="p">(</span><span class="n">norb</span> <span class="o">-</span> <span class="n">nocc</span><span class="p">)</span>
    
    <span class="n">kappa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">norb</span><span class="p">,</span><span class="n">norb</span><span class="p">))</span>
    
    <span class="n">kappa</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span> <span class="n">nocc</span><span class="p">:</span><span class="n">norb</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span> <span class="n">norb</span> <span class="o">-</span> <span class="n">nocc</span><span class="p">)</span>
    <span class="n">kappa</span><span class="p">[</span><span class="n">nocc</span><span class="p">:,</span> <span class="p">:</span><span class="n">nocc</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">N</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span> <span class="n">norb</span> <span class="o">-</span> <span class="n">nocc</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    
    <span class="k">return</span> <span class="n">kappa</span>
</pre></div>
</div>
</div>
</div>
<p>The polarizability can then be evaluated in the orignal AO basis according to</p>
<div class="math notranslate nohighlight">
\[
\alpha(-\omega; \omega) = \mathrm{tr}\big[ \mu \,\kappa \big] =
\sum_{\alpha,\beta} \mu_{\alpha\beta} D^{(1)}_{\alpha\beta}
\]</div>
<p>where we have introduced the perturbed density matrix</p>
<div class="math notranslate nohighlight">
\[
D^{(1)}_{\alpha\beta} =
\sum_{p,q} C^*_{\alpha p} C_{\beta q} \kappa_{qp}
\]</div>
<p>It can also be exressed in the LoProp basis</p>
<div class="math notranslate nohighlight">
\[
\alpha(-\omega; \omega) = \sum_{A,B} \alpha^\mathrm{L}_{AB}; \qquad
%
\alpha^\mathrm{L}_{AB} =
\sum_{\alpha \in A}
\sum_{\beta \in B}
\mu^\mathrm{L}_{\alpha\beta} D^{\mathrm{L},(1)}_{\beta\alpha}
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nocc</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">number_of_alpha_electrons</span><span class="p">()</span>

<span class="n">N</span> <span class="o">=</span> <span class="o">-</span> <span class="n">lrs_out</span><span class="p">[</span><span class="s1">&#39;solutions&#39;</span><span class="p">][(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>

<span class="n">kappa</span> <span class="o">=</span> <span class="n">vec2mat</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">norb</span><span class="p">)</span>

<span class="n">C</span> <span class="o">=</span> <span class="n">scf_drv</span><span class="o">.</span><span class="n">scf_tensors</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span>
<span class="c1"># factor of sqrt(2) due to use of normalized spin-adapted excitation operators</span>
<span class="c1"># in the formation of the property gradient, mu[1].</span>
<span class="n">D1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;QP,aP,bQ-&gt;ab&#39;</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">alpha_AB</span> <span class="o">=</span> <span class="n">atomic_property</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">D1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;alpha = </span><span class="si">{</span><span class="n">alpha_AB</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="si">:</span><span class="s2"> .6f</span><span class="si">}</span><span class="s2"> a.u.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">alpha_AB:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">alpha_AB</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>alpha =  3.869484 a.u.

alpha_AB:
 [[0.6304 0.2307]
 [0.2307 2.7776]]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="localized-polarizabilities">
<h3>Localized polarizabilities<a class="headerlink" href="#localized-polarizabilities" title="Permalink to this headline">¶</a></h3>
<p>We define gauge-origin independent local polarizability</p>
<div class="math notranslate nohighlight">
\[
\alpha^\mathrm{L}_{(AB)} =
-e 
\sum_{\alpha \in A}
\sum_{\beta \in B}
\langle \chi^\mathrm{L}_\alpha | (\hat{\boldsymbol{r}} - \boldsymbol{R}_{AB}) | \chi^\mathrm{L}_\beta \rangle D^{\mathrm{L},(1)}_{\beta\alpha}
\]</div>
<p>It can be determined from the relation</p>
<div class="math notranslate nohighlight">
\[
\alpha^\mathrm{L}_{(AB)} =
\alpha^\mathrm{L}_{AB}  - \Delta Q_A \boldsymbol{R}_{A} \delta_{AB}
\]</div>
<p>where the external field derivative of the change in charge on atom <span class="math notranslate nohighlight">\(A\)</span> is</p>
<div class="math notranslate nohighlight">
\[
\Delta Q_A = -e
\sum_{\alpha \in A} D^{\mathrm{L},(1)}_{\alpha\alpha}
\]</div>
<p>As charge is preserved, we have</p>
<div class="math notranslate nohighlight">
\[
\sum_A \Delta Q_A = 0
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dQ_A</span> <span class="o">=</span> <span class="o">-</span> <span class="n">atomic_property</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">D1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Lower case atomic indices for gauge-origin independent properties</span>
<span class="n">alpha_ab</span> <span class="o">=</span> <span class="n">alpha_AB</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">dQ_A</span><span class="p">)</span> <span class="o">*</span> <span class="n">R</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dQ_A:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dQ_A</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;alpha_(AB):</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">alpha_ab</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dQ_A:
 [-1.5231  1.5231]
alpha_(AB):
 [[0.3664 0.2307]
 [0.2307 0.4019]]
</pre></div>
</div>
</div>
</div>
<p>Next, we define an auxiliary charge transfer matrix with elements, <span class="math notranslate nohighlight">\(\Delta Q_{AB}\)</span>, as the external field derivative of the charge transfer from center <span class="math notranslate nohighlight">\(A\)</span> to <span class="math notranslate nohighlight">\(B\)</span>. Although this quantity is not uniquely defined, it has to fulfill</p>
<div class="math notranslate nohighlight">
\[
\sum_{A \neq B} \Delta Q_{AB} = \Delta Q_{A}
\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[
\Delta Q_{BA} = - \Delta Q_{AB}
\]</div>
<p>In the LoProp scheme, it assumed that <span class="math notranslate nohighlight">\(\Delta Q_{AB}\)</span> should be as small as possible and also that the charge transfer is short range. To accommodate these desired properties, a Lagrangian is formed</p>
<div class="math notranslate nohighlight">
\[ 
\mathcal{L}(\Delta Q_{AB}, \lambda_A) =  \sum_{AB} \big[ \Delta Q_{AB} \big]^2 f(\Delta R_{AB}) + 
\sum_{A} \lambda_A \big( \sum_{A \neq B} \Delta Q_{AB} - \Delta Q_A \big) 
\]</div>
<p>where <span class="math notranslate nohighlight">\(\Delta R_{AB} = |\boldsymbol{R}_A - \boldsymbol{R}_B|\)</span> and <span class="math notranslate nohighlight">\(f\)</span> is a penatly function preventing long-distance charge transfer chosen as</p>
<div class="math notranslate nohighlight">
\[
f(r) = \exp\Big(\alpha \Big(\frac{r}{R_A^\mathrm{BS} + R_B^\mathrm{BS}}\Big)^2\Big) 
\]</div>
<p>The constant <span class="math notranslate nohighlight">\(\alpha\)</span> is chosen equal to <span class="math notranslate nohighlight">\(2.0\)</span> and <span class="math notranslate nohighlight">\(R_A^\mathrm{BS}\)</span> is the Bragg–Slater radius of atom <span class="math notranslate nohighlight">\(A\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
    
    <span class="c1"># Bragg-Slater radii for F and H</span>
    <span class="n">bohr2ang</span> <span class="o">=</span> <span class="mf">0.529177249</span>
    <span class="n">R_BS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">])</span> <span class="o">/</span> <span class="n">bohr2ang</span>
    
    <span class="c1"># interatomic distance</span>
    <span class="n">dR_AB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">A</span><span class="p">,</span><span class="n">A</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="n">B</span><span class="p">,</span><span class="n">B</span><span class="p">,:])</span>
        
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">dR_AB</span> <span class="o">/</span> <span class="p">(</span><span class="n">R_BS</span><span class="p">[</span><span class="n">A</span><span class="p">]</span> <span class="o">+</span> <span class="n">R_BS</span><span class="p">[</span><span class="n">B</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The stationary point of the Lagrangian allows for a determination of the Lagrange multipliers from the equation</p>
<div class="math notranslate nohighlight">
\[
L \lambda = \Delta Q
\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[
L_{AB}  = \frac{1}{2 f(\Delta R_{AB})} + C
\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[
L_{AA}  = -\sum_{A \neq B} \frac{1}{2 f(\Delta R_{AB})} + C
\]</div>
<p>The constant <span class="math notranslate nohighlight">\(C\)</span> is determined from the requirement of charge conservation, or zero net charge transfer.</p>
<p>Once the Lagrange multipliers are determined, we have</p>
<div class="math notranslate nohighlight">
\[
\Delta Q_{AB} = - \frac{\lambda_{A} - \lambda_{B}}{2 f(\Delta R_{AB})}
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">L_AB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">natoms</span><span class="p">,</span> <span class="n">natoms</span><span class="p">))</span>

<span class="k">for</span> <span class="n">A</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">B</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>
        <span class="n">L_AB</span><span class="p">[</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">f</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">)</span>

    <span class="n">L_AB</span><span class="p">[</span><span class="n">A</span><span class="p">,</span><span class="n">A</span><span class="p">]</span> <span class="o">-=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">L_AB</span><span class="p">[</span><span class="n">A</span><span class="p">,:])</span>

<span class="n">L_AB</span> <span class="o">=</span> <span class="n">L_AB</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">L_AB</span><span class="p">))</span>

<span class="n">lambda_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L_AB</span><span class="p">,</span> <span class="n">dQ_A</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;lambda_A: </span><span class="si">{</span><span class="n">lambda_A</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>lambda_A: [ 30.2963 -30.2963]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dQ_AB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">natoms</span><span class="p">,</span><span class="n">natoms</span><span class="p">))</span>

<span class="k">for</span> <span class="n">A</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">B</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>

        <span class="n">dQ_AB</span><span class="p">[</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">lambda_A</span><span class="p">[</span><span class="n">A</span><span class="p">]</span> <span class="o">-</span> <span class="n">lambda_A</span><span class="p">[</span><span class="n">B</span><span class="p">])</span> <span class="o">/</span> <span class="n">f</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">dQ_AB</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[-0.     -1.5231]
 [ 1.5231 -0.    ]]
</pre></div>
</div>
</div>
</div>
<p>The <span class="math notranslate nohighlight">\(zz\)</span>-component of the bond polarizability is defined by</p>
<div class="math notranslate nohighlight">
\[
\alpha^\mathrm{bond}_{AB} =
\Delta Q_{AB} \Delta \boldsymbol{R}_{AB, z}
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alpha_bond_AB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">natoms</span><span class="p">,</span> <span class="n">natoms</span><span class="p">))</span>

<span class="k">for</span> <span class="n">A</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">B</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>
        <span class="n">alpha_bond_AB</span><span class="p">[</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">]</span> <span class="o">=</span> <span class="n">dQ_AB</span><span class="p">[</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">A</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="n">B</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
        
<span class="nb">print</span><span class="p">(</span><span class="n">alpha_bond_AB</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[-0.      2.6396]
 [ 2.6396 -0.    ]]
</pre></div>
</div>
</div>
</div>
<p>The LoProp polarizability for atom <span class="math notranslate nohighlight">\(A\)</span> is obtained as</p>
<div class="math notranslate nohighlight">
\[
\alpha^\mathrm{L}_A = \sum_B \Big(
\alpha^\mathrm{L}_{(AB)} + \frac{1}{2} \alpha^\mathrm{bond}_{AB}
\Big)
\]</div>
<p>and it fulfills</p>
<div class="math notranslate nohighlight">
\[
\sum_A \alpha^\mathrm{L}_A = \alpha(-\omega;\omega)
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alpha_A</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha_ab</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">alpha_bond_AB</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LoProp atomic polarizabilities: </span><span class="si">{</span><span class="n">alpha_A</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Molecular polarizability: </span><span class="si">{</span><span class="n">alpha_A</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="si">:</span><span class="s2"> .4f</span><span class="si">}</span><span class="s2"> a.u.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LoProp atomic polarizabilities: [1.917  1.9525]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Molecular polarizability:  3.8695 a.u.
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./docs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="resp.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">RESP charges</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="pe.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Polarizable embedding</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By The eChem team<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>