
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Potential energy surfaces by interpolation &#8212; Computational Chemistry from  Laptop to HPC</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Molecular dynamics" href="moldyn.html" />
    <link rel="prev" title="Transition state geometry optimization" href="transition_state.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Computational Chemistry from  Laptop to HPC</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Getting started
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Tutorials and workflows
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="uv-vis.html">
   UV/vis spectroscopies
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="uv-vis_calc.html">
     Spectrum calculation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="uv-vis_analysis.html">
     Spectrum analysis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="uv-vis_exercises.html">
     Exercises
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="vibrational.html">
   Vibrational spectroscopies
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="ir.html">
     IR spectroscopy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="raman.html">
     Raman spectroscopy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ir_raman_exercises.html">
     Exercises
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="xray.html">
   X-ray spectroscopies
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="xray_calc.html">
     Spectrum calculation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="xray_analysis.html">
     Spectrum analysis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="xray_aspects.html">
     Special aspects
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="xray_nonstandard.html">
     Non-standard calculations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="xray_rec.html">
     Recommendations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="xray_exercises.html">
     Exercises
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Electronic structure theory
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="elecstruct-general.html">
   General aspects
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="orbitals.html">
     Orbitals
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="basis.html">
     Basis sets
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="slater.html">
     Slater determinants
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="secondquant.html">
     Second quantization
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="wft.html">
   Wave function theory
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="wft-general.html">
     General aspects
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="hartree-fock.html">
     Hartree–Fock theory
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ci.html">
     Configuration interaction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="mp2.html">
     Møller–Plesset
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="mcscf.html">
     Multiconfigurational methods
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="wft-exercises.html">
     Exercises
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="dft.html">
   Density functional theory
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="hohenberg.html">
     Hohenberg–Kohn theorems
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="kohn-sham.html">
     Kohn–Sham method
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="kernel_integration.html">
     Kernel integration
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="dft_scf.html">
     SCF optimization of a closed-shell state
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Potential energy surfaces
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="pes-general.html">
   General aspects
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="coordinates.html">
     Choice of coordinates
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="gradients.html">
     Gradients
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="hessians.html">
     Hessians and vibrations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="forcefields.html">
     Force fields
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="structopt-overview.html">
   Molecular structure optimization
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="structopt.html">
     Optimization Methods
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="gsstructopt.html">
     Ground state structure optimization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="structopt-exercises.html">
     Exercises
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="tst.html">
   Transition-state theory
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
  <label for="toctree-checkbox-9">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="transition_state.html">
     Transition state geometry optimization
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Potential energy surfaces by interpolation
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="moldyn.html">
   Molecular dynamics
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
  <label for="toctree-checkbox-10">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="md_ffs.html">
     Force field parameterization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="md_setup.html">
     Ensembles and time integration
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="md_run.html">
     Running a simulation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="md_biased.html">
     Biased molecular dynamics
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Properties
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="response.html">
   Response theory
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
  <label for="toctree-checkbox-11">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="exact-response.html">
     Exact states
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="ci-response.html">
     Configuration interaction and state-averaged MCSCF
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="scf-response.html">
     Time-Dependent Hartree–Fock
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="tddft.html">
     TDDFT
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="response_exercises.html">
     Exercises
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="adc.html">
   Algebraic-diagrammatic construction
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
  <label for="toctree-checkbox-12">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="adc-isr.html">
     Intermediate state representation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="adc-cvs.html">
     Core–valence separation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="adc-hpc.html">
     HPC-QC implementation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="adc-exercises.html">
     ADC exercises
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="excoupl.html">
   Exciton coupling model
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
  <label for="toctree-checkbox-13">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="excoupl_impl.html">
     Implementation of the exciton coupling model
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Environment
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="localprop.html">
   Localized properties
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/>
  <label for="toctree-checkbox-14">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="esp.html">
     ESP charges
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="resp.html">
     RESP charges
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="loprop.html">
     LoProp charges and polarisabilities
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="pe.html">
   Polarizable embedding
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Visualization
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="visual-orbitals.html">
   Structure and orbitals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="visual-densities.html">
   Reduced particle densities
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="visual-excited.html">
   Excited states
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  References
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="refs.html">
   References
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/docs/impes.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/kthpanor/echem"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/kthpanor/echem/issues/new?title=Issue%20on%20page%20%2Fdocs/impes.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/kthpanor/echem/master?urlpath=tree/docs/docs/impes.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-ground-state-potential-energy-surface-of-water">
   The ground state potential energy surface of water
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#transforming-from-cartesian-to-internal-coordinates">
     Transforming from Cartesian to internal coordinates
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ground-state-pes-by-interpolation">
     Ground-state PES by interpolation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#todo-wrong-find-bug">
       TODO: wrong! find bug!
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Potential energy surfaces by interpolation</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-ground-state-potential-energy-surface-of-water">
   The ground state potential energy surface of water
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#transforming-from-cartesian-to-internal-coordinates">
     Transforming from Cartesian to internal coordinates
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ground-state-pes-by-interpolation">
     Ground-state PES by interpolation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#todo-wrong-find-bug">
       TODO: wrong! find bug!
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="potential-energy-surfaces-by-interpolation">
<h1>Potential energy surfaces by interpolation<a class="headerlink" href="#potential-energy-surfaces-by-interpolation" title="Permalink to this headline">¶</a></h1>
<p>In this tutorial we will get familiar with constructing the potential energy surface (PES) of a molecule by interpolation. The idea behind this method is to construct the global PES of the molecular ground or excited-state from a set of data points (configurations) calculated quantum-mechanically. For small molecules with few degrees of freedom, depending on the level of theory, the interpolated PES can have similar computational cost as constructing the PES <em>ab initio</em>. The use of an interpolated PES becomes very advantageous, especially when the molecule of interest is embedded in a larger environment (e.g. fluorescent probe in a protein), where this technique allows performing dynamics on the ground or excited state with quantum chemical accuracy, but at molecular mechanics computational cost.</p>
<p>The idea behind PES interpolation is to write the potential energy at a new configuration <span class="math notranslate nohighlight">\(\mathbf{q}\)</span> as a weighted average between potentials defined from a set of <em>ab initio</em> data points <span class="math notranslate nohighlight">\(\{\mathbf{q}_a\}\)</span>:</p>
<div class="math notranslate nohighlight">
\[
V(\mathbf{q}) = \sum_a w_a V_a(\mathbf{q})\,,
\]</div>
<p>where the weights <span class="math notranslate nohighlight">\(w_a\)</span> depend on the distance (<span class="math notranslate nohighlight">\(\boldsymbol{\Delta}_a\)</span>) beween the new configuration <span class="math notranslate nohighlight">\(\mathbf{q}\)</span> and a data configuration <span class="math notranslate nohighlight">\(\mathbf{q}_a\)</span>. The potentials <span class="math notranslate nohighlight">\(V_a\)</span> are local harmonic potentials written in terms of Taylor expansions based on the energy (<span class="math notranslate nohighlight">\(E_a\)</span>), gradient (<span class="math notranslate nohighlight">\(\mathbf{g}_a\)</span>) and Hessian (<span class="math notranslate nohighlight">\(\mathbf{H}_a\)</span>):</p>
<div class="math notranslate nohighlight">
\[
V_a(\mathbf{q}) = E_a + \boldsymbol{\Delta}^\mathrm{T}_a \mathbf{g}_a + \frac{1}{2} \boldsymbol{\Delta}^\mathrm{T}_a \mathbf{H}_a\boldsymbol{\Delta}_a\, .
\]</div>
<p>The vector <span class="math notranslate nohighlight">\(\mathbf{q}\)</span> designating the position is in the internal coordinate system. The weights are provided by considering the distance between <span class="math notranslate nohighlight">\(\mathbf{q}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{q}_a\)</span>, such that the weight <span class="math notranslate nohighlight">\(w_a\)</span> is larger for a data point <span class="math notranslate nohighlight">\(\mathbf{q}_a\)</span> that is closer to <span class="math notranslate nohighlight">\(\mathbf{q}\)</span>.</p>
<div class="section" id="the-ground-state-potential-energy-surface-of-water">
<h2>The ground state potential energy surface of water<a class="headerlink" href="#the-ground-state-potential-energy-surface-of-water" title="Permalink to this headline">¶</a></h2>
<p>Let’s construct the ground state PES for the water molecule by interpolation. We need to carry out the following steps:</p>
<ul class="simple">
<li><p>Transform the coordinates, gradients and Hessians from Cartesian coordinates to internal coordinates,</p></li>
<li><p>Calculate the ground state energy, gradient, and Hessian for a several molecular configurations which will serve as data points for interpolation,</p></li>
<li><p>Determine the harmonic potentials and weights,</p></li>
<li><p>Perform the interpolation and determine the potential energy at new configurations <span class="math notranslate nohighlight">\(\mathbf{q}\)</span>.</p></li>
</ul>
<div class="section" id="transforming-from-cartesian-to-internal-coordinates">
<h3>Transforming from Cartesian to internal coordinates<a class="headerlink" href="#transforming-from-cartesian-to-internal-coordinates" title="Permalink to this headline">¶</a></h3>
<p>The steps required for the transformation of Cartesian coordinates to internal coordinates are described in details <a class="reference internal" href="coordinates.html#sec-redundant-coordinates"><span class="std std-ref">here</span></a>. We will implement a set of routines to transform the gradient and Hessian to internal coordinates, making use of routines from <a class="reference external" href="https://github.com/leeping/geomeTRIC">geomeTRIC</a>. Let’s start by setting up the molecule and calculating the energy, gradient and Hessian. To make things faster, we will use the <a class="reference external" href="https://xtb-docs.readthedocs.io/en/latest/contents.html">XTB</a> driver to run our calculations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">veloxchem</span> <span class="k">as</span> <span class="nn">vlx</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">py3Dmol</span> <span class="k">as</span> <span class="nn">p3d</span>
<span class="kn">import</span> <span class="nn">geometric</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning: importing &#39;simtk.openmm&#39; is deprecated.  Import &#39;openmm&#39; instead.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>* Warning * Environment variable OMP_NUM_THREADS not set.
* Warning * Setting OMP_NUM_THREADS to 4.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">molecule_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;3</span>
<span class="s2">water                                                                                                                          </span>
<span class="s2">O    0.000000000000        0.000000000000        0.000000000000                         </span>
<span class="s2">H    0.000000000000        0.895700000000       -0.316700000000                         </span>
<span class="s2">H    0.000000000000        0.000000000000        1.100000000000</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">molecule</span> <span class="o">=</span> <span class="n">vlx</span><span class="o">.</span><span class="n">Molecule</span><span class="o">.</span><span class="n">from_xyz_string</span><span class="p">(</span><span class="n">molecule_string</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Initial Geometry of the water molecule:&quot;</span><span class="p">)</span>
<span class="n">viewer</span> <span class="o">=</span> <span class="n">p3d</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">viewergrid</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">width</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">viewer</span><span class="o">.</span><span class="n">addModel</span><span class="p">(</span><span class="n">molecule_string</span><span class="p">,</span> <span class="s1">&#39;xyz&#39;</span><span class="p">,</span> <span class="n">viewer</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="n">viewer</span><span class="o">.</span><span class="n">setStyle</span><span class="p">({</span><span class="s1">&#39;stick&#39;</span><span class="p">:</span> <span class="p">{}})</span>
<span class="n">viewer</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">viewer</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Initial Geometry of the water molecule:
</pre></div>
</div>
<div class="output text_html"><div id="3dmolviewer_1651223931204287"  style="position: relative; width: 300px; height: 200px">
        <p id="3dmolwarning_1651223931204287" style="background-color:#ffcccc;color:black">You appear to be running in JupyterLab (or JavaScript failed to load for some other reason).  You need to install the 3dmol extension: <br>
        <tt>jupyter labextension install jupyterlab_3dmol</tt></p>
        </div>
<script>

var loadScriptAsync = function(uri){
  return new Promise((resolve, reject) => {
    var tag = document.createElement('script');
    tag.src = uri;
    tag.async = true;
    tag.onload = () => {
      resolve();
    };
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
});
};

if(typeof $3Dmolpromise === 'undefined') {
$3Dmolpromise = null;
  $3Dmolpromise = loadScriptAsync('https://3dmol.org/build/3Dmol.js');
}

var viewer_1651223931204287 = null;
var warn = document.getElementById("3dmolwarning_1651223931204287");
if(warn) {
    warn.parentNode.removeChild(warn);
}
$3Dmolpromise.then(function() {
var viewergrid_1651223931204287 = null;
viewergrid_1651223931204287 = $3Dmol.createViewerGrid($("#3dmolviewer_1651223931204287"),{rows: 1, cols: 1, control_all: true},{backgroundColor:"white"});
viewer_1651223931204287 = viewergrid_1651223931204287[0][0];
viewergrid_1651223931204287[0][0].zoomTo();	viewergrid_1651223931204287[0][0].addModel("3\nwater                                                                                                                          \nO    0.000000000000        0.000000000000        0.000000000000                         \nH    0.000000000000        0.895700000000       -0.316700000000                         \nH    0.000000000000        0.000000000000        1.100000000000\n","xyz");
	viewergrid_1651223931204287[0][0].setStyle({"stick": {}});
	viewergrid_1651223931204287[0][0].rotate(-90,"y");
viewergrid_1651223931204287[0][0].render();
});
</script></div></div>
</div>
<p>Calculating the desired properties:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">method_settings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;xtb&#39;</span><span class="p">:</span> <span class="s1">&#39;gfn2&#39;</span><span class="p">}</span>
<span class="n">ostream</span> <span class="o">=</span> <span class="n">vlx</span><span class="o">.</span><span class="n">OutputStream</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
<span class="n">xtb_drv</span> <span class="o">=</span> <span class="n">vlx</span><span class="o">.</span><span class="n">XTBDriver</span><span class="p">()</span>

<span class="c1"># Energy</span>
<span class="n">xtb_drv</span><span class="o">.</span><span class="n">set_method</span><span class="p">(</span><span class="n">method_settings</span><span class="p">[</span><span class="s1">&#39;xtb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
<span class="n">xtb_drv</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">ostream</span><span class="p">)</span>
<span class="n">energy</span> <span class="o">=</span> <span class="n">xtb_drv</span><span class="o">.</span><span class="n">get_energy</span><span class="p">()</span>

<span class="c1"># Gradient</span>
<span class="n">xtb_grad_drv</span> <span class="o">=</span> <span class="n">vlx</span><span class="o">.</span><span class="n">XTBGradientDriver</span><span class="p">(</span><span class="n">xtb_drv</span><span class="p">)</span>
<span class="n">xtb_grad_drv</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>
<span class="n">gradient</span> <span class="o">=</span> <span class="n">xtb_grad_drv</span><span class="o">.</span><span class="n">gradient</span>

<span class="c1"># Hessian</span>
<span class="n">xtb_hessian_drv</span> <span class="o">=</span> <span class="n">vlx</span><span class="o">.</span><span class="n">XTBHessianDriver</span><span class="p">(</span><span class="n">xtb_drv</span><span class="p">)</span>
<span class="n">xtb_hessian_drv</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>
<span class="n">hessian</span> <span class="o">=</span> <span class="n">xtb_hessian_drv</span><span class="o">.</span><span class="n">hessian</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">AssertionError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)
<span class="nn">Input In [3],</span> in <span class="ni">&lt;cell line: 7&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="c1"># Energy</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">xtb_drv</span><span class="o">.</span><span class="n">set_method</span><span class="p">(</span><span class="n">method_settings</span><span class="p">[</span><span class="s1">&#39;xtb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
<span class="ne">----&gt; </span><span class="mi">7</span> <span class="n">xtb_drv</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">ostream</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="n">energy</span> <span class="o">=</span> <span class="n">xtb_drv</span><span class="o">.</span><span class="n">get_energy</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="c1"># Gradient</span>

<span class="nn">File ~/Notebook/anaconda/envs/echem/lib/python3.9/site-packages/veloxchem/xtbdriver.py:46,</span> in <span class="ni">_XTBDriver_compute</span><span class="nt">(self, molecule, ostream)</span>
<span class="g g-Whitespace">     </span><span class="mi">44</span> <span class="n">errmsg</span> <span class="o">+=</span> <span class="s1">&#39;from https://github.com/grimme-lab/xtb, set XTBHOME environment &#39;</span>
<span class="g g-Whitespace">     </span><span class="mi">45</span> <span class="n">errmsg</span> <span class="o">+=</span> <span class="s1">&#39;variable, and reinstall VeloxChem.&#39;</span>
<span class="ne">---&gt; </span><span class="mi">46</span> <span class="n">assert_msg_critical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_available</span><span class="p">(),</span> <span class="n">errmsg</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">48</span> <span class="n">start_time</span> <span class="o">=</span> <span class="n">tm</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">50</span> <span class="n">ostream</span><span class="o">.</span><span class="n">print_blank</span><span class="p">()</span>

<span class="nn">File ~/Notebook/anaconda/envs/echem/lib/python3.9/site-packages/veloxchem/errorhandler.py:42,</span> in <span class="ni">assert_msg_critical</span><span class="nt">(condition, msg)</span>
<span class="g g-Whitespace">     </span><span class="mi">32</span> <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">     </span><span class="mi">33</span><span class="sd"> Asserts that the condition is true. Otherwise terminates the program with</span>
<span class="g g-Whitespace">     </span><span class="mi">34</span><span class="sd"> an error message.</span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">     </span><span class="mi">39</span><span class="sd">     The error message.</span>
<span class="g g-Whitespace">     </span><span class="mi">40</span><span class="sd"> &quot;&quot;&quot;</span>
<span class="g g-Whitespace">     </span><span class="mi">41</span> <span class="k">if</span> <span class="n">__debug__</span> <span class="ow">and</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">42</span>     <span class="k">assert</span> <span class="n">condition</span><span class="p">,</span> <span class="n">msg</span>
<span class="g g-Whitespace">     </span><span class="mi">43</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">44</span>     <span class="n">vlx_assert</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

<span class="ne">AssertionError</span>: XTBDriver: XTB not available. Please download and install XTB from https://github.com/grimme-lab/xtb, set XTBHOME environment variable, and reinstall VeloxChem.
</pre></div>
</div>
</div>
</div>
<p>Now that we have an energy, gradient and Hessian, let’s define the Z-matrix for the water molecule and write the routines required to transform from Cartesian coordinates to the internal coordinates defined by the Z-matrix. We will use geomeTRIC to set up the internal coordinates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#            O-H1    O-H2   H1-O-H2</span>
<span class="n">z_matrix</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span>

<span class="n">internal_coordinates</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">z_matrix</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># define a bond distance object</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">geometric</span><span class="o">.</span><span class="n">internal</span><span class="o">.</span><span class="n">Distance</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># define a bond angle object</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">geometric</span><span class="o">.</span><span class="n">internal</span><span class="o">.</span><span class="n">Angle</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># define a dihedral angle object</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">geometric</span><span class="o">.</span><span class="n">internal</span><span class="o">.</span><span class="n">Dihedral</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        
    <span class="n">internal_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The internal coordinates defined through geomeTRIC have routines that allow us to calculate derivatives with respect to Cartesian coordinates (<span class="math notranslate nohighlight">\(\mathbf{x}\)</span>), as required for constructing the Wilson <span class="math notranslate nohighlight">\(\mathbf{B}\)</span>-matrix:</p>
<div class="math notranslate nohighlight">
\[
B_{ij} = \frac{\partial q_i}{\partial x_j}\,.
\]</div>
<p>Let us use these routines to get the <span class="math notranslate nohighlight">\(\mathbf{B}\)</span>-matrix.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_b_matrix</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">internal_coordinates</span><span class="p">,</span> <span class="n">z_matrix</span><span class="p">):</span>
    <span class="n">n_atoms</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">number_of_atoms</span><span class="p">()</span>
    
    <span class="c1"># number of Cartesian coordinates</span>
    <span class="n">n_cart</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">n_atoms</span>
    
    <span class="c1"># number of internal coordinates</span>
    <span class="n">n_int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">internal_coordinates</span><span class="p">)</span>
    
    <span class="c1"># initialize the B-matrix</span>
    <span class="n">b_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_int</span><span class="p">,</span> <span class="n">n_cart</span><span class="p">))</span>
    
    <span class="c1"># Cartesian coordinates</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">n_atoms</span><span class="p">)</span>
    
    <span class="c1"># calculate the derivatives of q with respect to coords</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># i runs over all the internal coordinates</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">internal_coordinates</span><span class="p">:</span>
        <span class="n">deriv_q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">derivative</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="c1"># add the derivative values in the right spots of the b_matrix;</span>
        <span class="c1"># we need the atom indices from the Z-matrix.</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">z_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="c1"># from 3 * atom_index to 3 * atom_index + 3</span>
            <span class="n">b_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">a</span> <span class="p">:</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="n">deriv_q</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">b_matrix</span>

<span class="n">b_mat</span> <span class="o">=</span> <span class="n">get_b_matrix</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">internal_coordinates</span><span class="p">,</span> <span class="n">z_matrix</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>In order to transform from <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> to <span class="math notranslate nohighlight">\(\mathbf{q}\)</span> we would need the inverse of <span class="math notranslate nohighlight">\(\mathbf{B}\)</span>. However, <span class="math notranslate nohighlight">\(\mathbf{B}\)</span> is not a square matrix, so to get the inverse we have to first construct a rectangular matrix <span class="math notranslate nohighlight">\(\mathbf{G}=\mathbf{B}\mathbf{B}^\mathrm{T}\)</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">g_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">b_mat</span><span class="p">,</span> <span class="n">b_mat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><span class="math notranslate nohighlight">\(\mathbf{G}\)</span> is diagnoalized to get its eigenvalues and eigenvectors. The inverse of the non-zero eigenvalues and corresponding eigenvectors will be then used to construct the <span class="math notranslate nohighlight">\(\mathbf{G}^{-}\)</span> matrix.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">g_val</span><span class="p">,</span> <span class="n">g_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">g_mat</span><span class="p">)</span>
<span class="n">g_val_inverse</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">g_val</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-7</span><span class="p">:</span>
        <span class="n">g_val_inverse</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">g</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g_val_inverse</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">g_val_inverse_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">g_val_inverse</span><span class="p">))</span>
<span class="n">g_minus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">([</span><span class="n">g_vec</span><span class="p">,</span> <span class="n">g_val_inverse_mat</span><span class="p">,</span> <span class="n">g_vec</span><span class="o">.</span><span class="n">T</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s make this piece of code a general routine that we can use for an arbitrary <span class="math notranslate nohighlight">\(\mathbf{B}\)</span> matrix.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_g_minus</span><span class="p">(</span><span class="n">b_matrix</span><span class="p">):</span>
    <span class="n">g_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">b_matrix</span><span class="p">,</span> <span class="n">b_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">g_val</span><span class="p">,</span> <span class="n">g_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">g_mat</span><span class="p">)</span>
    <span class="n">g_val_inverse</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">g_val</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-7</span><span class="p">:</span>
            <span class="n">g_val_inverse</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">g</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g_val_inverse</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            
    <span class="n">g_val_inverse_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">g_val_inverse</span><span class="p">))</span>
    <span class="n">g_minus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">([</span><span class="n">g_vec</span><span class="p">,</span> <span class="n">g_val_inverse_mat</span><span class="p">,</span> <span class="n">g_vec</span><span class="o">.</span><span class="n">T</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">g_minus</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">get_g_minus</span><span class="p">(</span><span class="n">b_mat</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<p>Now we have all the ingredients to transform the gradient, but we need the second order derivatives of <span class="math notranslate nohighlight">\(\mathbf{q}\)</span> with respect to <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> to be able to also transform the Hessian. Let’s write a routine to calculate the second-order B-matrix, <span class="math notranslate nohighlight">\(\mathbf{B}^{(2)}\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_b2_matrix</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">internal_coordinates</span><span class="p">,</span> <span class="n">z_matrix</span><span class="p">):</span>
    <span class="n">n_atoms</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">number_of_atoms</span><span class="p">()</span>
    
    <span class="c1"># number of Cartesian coordinates</span>
    <span class="n">n_cart</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">n_atoms</span>
    
    <span class="c1"># number of internal coordinates</span>
    <span class="n">n_int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">internal_coordinates</span><span class="p">)</span>
    
    <span class="c1"># initialize the B-matrix</span>
    <span class="n">b2_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_int</span><span class="p">,</span> <span class="n">n_cart</span><span class="p">,</span> <span class="n">n_cart</span><span class="p">))</span>
    
    <span class="c1"># Cartesian coordinates</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">n_atoms</span><span class="p">)</span>
    
    <span class="c1"># calculate the derivatives of q with respect to coords</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># i runs over all the internal coordinates</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">internal_coordinates</span><span class="p">:</span>
        <span class="n">second_deriv_q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">second_derivative</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="c1"># add the derivative values in the right spots of the b_matrix;</span>
        <span class="c1"># we need the atom indices from the Z-matrix.</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">z_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">z_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="c1"># from 3 * atom_index_a to 3 * atom_index_a + 3</span>
                <span class="c1"># and from 3 * atom_index_b to 3 * atom_index_b + 3</span>
                <span class="n">b2_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">a</span> <span class="p">:</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> 
                             <span class="mi">3</span> <span class="o">*</span> <span class="n">b</span> <span class="p">:</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">second_deriv_q</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:,</span> <span class="n">b</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">b2_matrix</span>

<span class="n">b2_matrix</span> <span class="o">=</span> <span class="n">get_b2_matrix</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">internal_coordinates</span><span class="p">,</span> <span class="n">z_matrix</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s write the routines which transform the gradient and the Hessian from Cartesian coordinates to internal coordinates. We have to implement the following equations:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\mathbf{g}_q = \mathbf{G}^{-}\mathbf{B}\mathbf{g}_x \\
\mathbf{H}_q = \mathbf{G}^{-}\mathbf{B}\big[ \mathbf{H}_x - \mathbf{g}_q\mathbf{B}^{(2)}\big]\mathbf{B}^\mathrm{T}\mathbf{G}^{-\mathrm{T}} 
\end{split}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">convert_gradient_to_internal</span><span class="p">(</span><span class="n">gradient</span><span class="p">,</span> <span class="n">b_matrix</span><span class="p">,</span> <span class="n">g_minus</span><span class="p">):</span>
    <span class="n">n_atoms</span> <span class="o">=</span> <span class="n">gradient</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># reshape the Cartesian gradient to match the dimensions of the </span>
    <span class="c1"># g_minus and b_matrix</span>
    <span class="n">grad_x</span> <span class="o">=</span> <span class="n">gradient</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span> <span class="o">*</span> <span class="n">n_atoms</span><span class="p">))</span>
    
    <span class="c1"># convert to internal coordinates</span>
    <span class="n">grad_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">([</span><span class="n">g_minus</span><span class="p">,</span> <span class="n">b_matrix</span><span class="p">,</span> <span class="n">grad_x</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">grad_q</span>

<span class="n">grad_q</span> <span class="o">=</span> <span class="n">convert_gradient_to_internal</span><span class="p">(</span><span class="n">gradient</span><span class="p">,</span> <span class="n">b_mat</span><span class="p">,</span> <span class="n">g_minus</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">grad_q</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Has the conversion worked correctly? How can you check?</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">convert_Hessian_to_internal</span><span class="p">(</span><span class="n">hessian</span><span class="p">,</span> <span class="n">b_matrix</span><span class="p">,</span> <span class="n">g_minus</span><span class="p">,</span> <span class="n">b2_matrix</span><span class="p">,</span> <span class="n">grad_q</span><span class="p">):</span>
    <span class="c1"># calculate term related to the second order B-matrix</span>
    <span class="n">gradq_b2mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;i,ixy-&gt;xy&quot;</span><span class="p">,</span> <span class="n">grad_q</span><span class="p">,</span> <span class="n">b2_matrix</span><span class="p">)</span>
    
    <span class="c1"># convert the Hessian from Cartesian to internal coordinates</span>
    <span class="n">hessian_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">([</span><span class="n">g_minus</span><span class="p">,</span> <span class="n">b_matrix</span><span class="p">,</span> <span class="n">hessian</span> <span class="o">-</span> <span class="n">gradq_b2mat</span><span class="p">,</span> <span class="n">b_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">g_minus</span><span class="o">.</span><span class="n">T</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">hessian_q</span>

<span class="n">hessian_q</span> <span class="o">=</span> <span class="n">convert_Hessian_to_internal</span><span class="p">(</span><span class="n">hessian</span><span class="p">,</span> <span class="n">b_mat</span><span class="p">,</span> <span class="n">g_minus</span><span class="p">,</span> <span class="n">b2_matrix</span><span class="p">,</span> <span class="n">grad_q</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">hessian_q</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="ground-state-pes-by-interpolation">
<h3>Ground-state PES by interpolation<a class="headerlink" href="#ground-state-pes-by-interpolation" title="Permalink to this headline">¶</a></h3>
<p>Now that we have set up the routines for conversion between Cartesian and internal coordiantes, we can start collecting data points for interpolation. Let’s start with stretching one of the OH bonds and calculate three new points: one when the bond is contracted, one around equilibrium bond length, and one when the bond is stretched.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mol_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;                                                                                                              </span>
<span class="s2">O    0.000000000000        0.000000000000        0.000000000000                         </span>
<span class="s2">H    0.000000000000        0.895700000000       -0.316700000000                         </span>
<span class="s2">H    0.000000000000        0.000000000000        OHdist</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># list of bond distances</span>
<span class="n">distlist</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">1.35</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># empty list to save the energies, gradients and hessians</span>
<span class="n">energies</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">cart_gradients</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">cart_hessians</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># list for molecular configurations</span>
<span class="n">molecules</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">ostream</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># to disable printout</span>

<span class="k">for</span> <span class="n">oh</span> <span class="ow">in</span> <span class="n">distlist</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating the energies, gradients and Hessians for... &quot;</span><span class="p">,</span> <span class="n">oh</span><span class="p">)</span>
    
    <span class="c1"># Create new molecule</span>
    <span class="n">mol_str</span> <span class="o">=</span> <span class="n">mol_template</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;OHdist&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">oh</span><span class="p">))</span>
    <span class="n">new_molecule</span> <span class="o">=</span> <span class="n">vlx</span><span class="o">.</span><span class="n">Molecule</span><span class="o">.</span><span class="n">read_str</span><span class="p">(</span><span class="n">mol_str</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;angstrom&#39;</span><span class="p">)</span>
    
    <span class="c1"># set-up an xtb driver, gradient driver and hessian driver</span>
    <span class="n">new_xtb_drv</span> <span class="o">=</span> <span class="n">vlx</span><span class="o">.</span><span class="n">XTBDriver</span><span class="p">()</span>
    <span class="n">new_xtb_drv</span><span class="o">.</span><span class="n">set_method</span><span class="p">(</span><span class="n">method_settings</span><span class="p">[</span><span class="s1">&#39;xtb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="n">new_xtb_drv</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">new_molecule</span><span class="p">,</span> <span class="n">ostream</span><span class="p">)</span>
    
    <span class="n">new_xtb_grad_drv</span> <span class="o">=</span> <span class="n">vlx</span><span class="o">.</span><span class="n">XTBGradientDriver</span><span class="p">(</span><span class="n">new_xtb_drv</span><span class="p">)</span>
    <span class="n">new_xtb_grad_drv</span><span class="o">.</span><span class="n">ostream</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># to disable printout</span>
    <span class="n">new_xtb_grad_drv</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">new_molecule</span><span class="p">)</span>
    
    <span class="n">new_xtb_hessian_drv</span> <span class="o">=</span> <span class="n">vlx</span><span class="o">.</span><span class="n">XTBHessianDriver</span><span class="p">(</span><span class="n">new_xtb_drv</span><span class="p">)</span>
    <span class="n">new_xtb_hessian_drv</span><span class="o">.</span><span class="n">ostream</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">new_xtb_hessian_drv</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">new_molecule</span><span class="p">)</span>
    
    <span class="c1"># save the results:</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="n">new_xtb_drv</span><span class="o">.</span><span class="n">get_energy</span><span class="p">()</span>
    <span class="n">cart_gradient</span> <span class="o">=</span> <span class="n">new_xtb_grad_drv</span><span class="o">.</span><span class="n">gradient</span>
    <span class="n">cart_hessian</span> <span class="o">=</span> <span class="n">new_xtb_hessian_drv</span><span class="o">.</span><span class="n">hessian</span>
    
    <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
    <span class="n">cart_gradients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cart_gradient</span><span class="p">)</span>
    <span class="n">cart_hessians</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cart_hessian</span><span class="p">)</span>
    <span class="n">molecules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_molecule</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Calculating the energies, gradients and Hessians for...  0.75
Calculating the energies, gradients and Hessians for...  0.95
Calculating the energies, gradients and Hessians for...  1.35
</pre></div>
</div>
</div>
</div>
<p>Now we have to transform the gradient and Hessian from Cartesian to internal coordinates in order to be able to use them for interpolation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># number of data points:</span>
<span class="n">n_data_pts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>

<span class="c1"># empty lists for the internal gradients and Hessians:</span>
<span class="n">int_gradients</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">int_hessians</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_data_pts</span><span class="p">):</span>
    <span class="n">grad_x</span> <span class="o">=</span> <span class="n">cart_gradients</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">hess_x</span> <span class="o">=</span> <span class="n">cart_hessians</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">molecules</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">b_mat</span> <span class="o">=</span> <span class="n">get_b_matrix</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">internal_coordinates</span><span class="p">,</span> <span class="n">z_matrix</span><span class="p">)</span>
    <span class="n">g_minus</span> <span class="o">=</span> <span class="n">get_g_minus</span><span class="p">(</span><span class="n">b_mat</span><span class="p">)</span>
    <span class="n">b2_mat</span> <span class="o">=</span> <span class="n">get_b2_matrix</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">internal_coordinates</span><span class="p">,</span> <span class="n">z_matrix</span><span class="p">)</span>
    
    <span class="n">grad_q</span> <span class="o">=</span> <span class="n">convert_gradient_to_internal</span><span class="p">(</span><span class="n">grad_x</span><span class="p">,</span> <span class="n">b_mat</span><span class="p">,</span> <span class="n">g_minus</span><span class="p">)</span>
    <span class="n">hess_q</span> <span class="o">=</span> <span class="n">convert_Hessian_to_internal</span><span class="p">(</span><span class="n">hess_x</span><span class="p">,</span> <span class="n">b_mat</span><span class="p">,</span> <span class="n">g_minus</span><span class="p">,</span> <span class="n">b2_mat</span><span class="p">,</span> <span class="n">grad_q</span><span class="p">)</span>
    <span class="n">int_gradients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grad_q</span><span class="p">)</span>
    <span class="n">int_hessians</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hess_q</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now that we have the gradients and Hessians in internal coordinates, let’s write a routine which constructs the harmonic potential, given a new molecular configuration <span class="math notranslate nohighlight">\(\mathbf{q}\)</span>.</p>
<div class="math notranslate nohighlight">
\[
V_a(\mathbf{q}) = E_a + \boldsymbol{\Delta}^\mathrm{T}_a \mathbf{g}_a + \frac{1}{2} \boldsymbol{\Delta}^\mathrm{T}_a \mathbf{H}_a\boldsymbol{\Delta}_a\, .
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_harmonic_potential</span><span class="p">(</span><span class="n">q_a</span><span class="p">,</span> <span class="n">e_a</span><span class="p">,</span> <span class="n">g_a</span><span class="p">,</span> <span class="n">h_a</span><span class="p">,</span> <span class="n">new_q</span><span class="p">):</span>
    <span class="c1"># coords_a are the coordinates where the energy, gradient and</span>
    <span class="c1"># hessian have been calculated;</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">new_q</span> <span class="o">-</span> <span class="n">q_a</span>
    <span class="n">pot</span> <span class="o">=</span> <span class="n">e_a</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">g_a</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">([</span><span class="n">dist</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">h_a</span><span class="p">,</span> <span class="n">dist</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">pot</span>    
</pre></div>
</div>
</div>
</div>
<p>To be able to use the routine, we first have to create the arrya of internal coordinates <span class="math notranslate nohighlight">\(\mathbf{q}_a\)</span>. Let’s add a routine to calculate it from the geomeTRIC internal coordinates and molecular Cartesian coordinates.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Cartesian and internal coordinates used here are in atomic units!</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_internal_coordinates_array</span><span class="p">(</span><span class="n">internal_coordinates</span><span class="p">,</span> <span class="n">cart_coords</span><span class="p">):</span>
    <span class="n">q_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">internal_coordinates</span><span class="p">:</span>
        <span class="n">q_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">cart_coords</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">q_list</span><span class="p">)</span>

<span class="c1"># list of internal coordinates with our interpolation data points:</span>
<span class="n">qs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">molec</span> <span class="ow">in</span> <span class="n">molecules</span><span class="p">:</span>
    <span class="n">cart_coords</span> <span class="o">=</span> <span class="n">molec</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">()</span>
    <span class="n">q_a</span> <span class="o">=</span> <span class="n">get_internal_coordinates_array</span><span class="p">(</span><span class="n">internal_coordinates</span><span class="p">,</span> <span class="n">cart_coords</span><span class="p">)</span>
    <span class="n">qs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_a</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s construct the harmonic potentials based on the three data points we calculated previously. To plot the results let’s use an array of new O-H bond distances.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">get_harmonic_potential</span><span class="p">(</span><span class="n">qs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">int_gradients</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">int_hessians</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-5.001312242376127
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">distlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">2.0</span><span class="p">,</span><span class="mf">0.05</span><span class="p">)</span>

<span class="c1"># list of harmonic potentials</span>
<span class="n">harmonic_potentials</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_data_pts</span><span class="p">):</span>
    <span class="n">q_a</span> <span class="o">=</span> <span class="n">qs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">e_a</span> <span class="o">=</span> <span class="n">energies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">g_a</span> <span class="o">=</span> <span class="n">int_gradients</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">h_a</span> <span class="o">=</span> <span class="n">int_hessians</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    
    <span class="n">potential</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">oh</span> <span class="ow">in</span> <span class="n">distlist</span><span class="p">:</span>
        <span class="c1">#print(&quot;Calculating the harmonic potential for... &quot;, oh)</span>
    
        <span class="c1"># Create new molecule</span>
        <span class="n">mol_str</span> <span class="o">=</span> <span class="n">mol_template</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;OHdist&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">oh</span><span class="p">))</span>
        <span class="n">new_molecule</span> <span class="o">=</span> <span class="n">vlx</span><span class="o">.</span><span class="n">Molecule</span><span class="o">.</span><span class="n">read_str</span><span class="p">(</span><span class="n">mol_str</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;angstrom&#39;</span><span class="p">)</span>
        <span class="n">cart_coords</span> <span class="o">=</span> <span class="n">new_molecule</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">()</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">get_internal_coordinates_array</span><span class="p">(</span><span class="n">internal_coordinates</span><span class="p">,</span> <span class="n">cart_coords</span><span class="p">)</span>
        
        <span class="c1"># Calculate harmonic potential at point q</span>
        <span class="n">pot</span> <span class="o">=</span> <span class="n">get_harmonic_potential</span><span class="p">(</span><span class="n">q_a</span><span class="p">,</span> <span class="n">e_a</span><span class="p">,</span> <span class="n">g_a</span><span class="p">,</span> <span class="n">h_a</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
        <span class="n">potential</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pot</span><span class="p">)</span>
    <span class="n">harmonic_potentials</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">potential</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s plot the results.</p>
<div class="section" id="todo-wrong-find-bug">
<h4>TODO: wrong! find bug!<a class="headerlink" href="#todo-wrong-find-bug" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Local Harmonic Potentials for Interpolation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">distlist</span><span class="p">,</span> <span class="n">harmonic_potentials</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;0.75A&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">distlist</span><span class="p">,</span> <span class="n">harmonic_potentials</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;0.95A&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">distlist</span><span class="p">,</span> <span class="n">harmonic_potentials</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;1.35A&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/impes_36_0.png" src="../_images/impes_36_0.png" />
</div>
</div>
<p>Let’s use these for interpolation and compare to the PES calculated with XTB.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_interpolated_pes</span><span class="p">(</span><span class="n">new_point</span><span class="p">,</span> <span class="n">data_points</span><span class="p">,</span> <span class="n">exponent</span><span class="p">):</span>
    <span class="c1"># sum of all interpolation weights -- to normalize them</span>
    <span class="n">sum_weights</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">potentials</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">q_a</span> <span class="ow">in</span> <span class="n">data_points</span><span class="p">:</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">new_point</span> <span class="o">-</span> <span class="n">q_a</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">dist</span><span class="o">**</span><span class="n">exponent</span>
        <span class="n">pot</span> <span class="o">=</span> <span class="n">get_harmonic_potential</span><span class="p">(</span><span class="n">q_a</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">],</span> <span class="n">q_a</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">],</span> <span class="n">q_a</span><span class="p">[</span><span class="s1">&#39;gradient&#39;</span><span class="p">],</span> <span class="n">q_a</span><span class="p">[</span><span class="s1">&#39;hessian&#39;</span><span class="p">],</span> <span class="n">new_point</span><span class="p">)</span>
        <span class="n">sum_weights</span> <span class="o">+=</span> <span class="n">weight</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">potentials</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pot</span><span class="p">)</span>
        
    <span class="n">weights</span> <span class="o">/=</span> <span class="n">sum_weights</span>

    <span class="n">energy</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_points</span><span class="p">)):</span>
        <span class="n">energy</span> <span class="o">+=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">potentials</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">energy</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xtb_energies</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">impes_energies</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">oh</span> <span class="ow">in</span> <span class="n">distlist</span><span class="p">:</span>
    
    <span class="c1"># Create new molecule</span>
    <span class="n">mol_str</span> <span class="o">=</span> <span class="n">mol_template</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;OHdist&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">oh</span><span class="p">))</span>
    <span class="n">new_molecule</span> <span class="o">=</span> <span class="n">vlx</span><span class="o">.</span><span class="n">Molecule</span><span class="o">.</span><span class="n">read_str</span><span class="p">(</span><span class="n">mol_str</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;angstrom&#39;</span><span class="p">)</span>
    
    <span class="c1"># set-up an xtb driver, gradient driver and hessian driver</span>
    <span class="n">new_xtb_drv</span> <span class="o">=</span> <span class="n">vlx</span><span class="o">.</span><span class="n">XTBDriver</span><span class="p">()</span>
    <span class="n">new_xtb_drv</span><span class="o">.</span><span class="n">set_method</span><span class="p">(</span><span class="n">method_settings</span><span class="p">[</span><span class="s1">&#39;xtb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="n">new_xtb_drv</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">new_molecule</span><span class="p">,</span> <span class="n">ostream</span><span class="p">)</span>
    
    <span class="c1"># save the results:</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="n">new_xtb_drv</span><span class="o">.</span><span class="n">get_energy</span><span class="p">()</span>
    
    <span class="n">xtb_energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Energy during O-H dissociation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">distlist</span><span class="p">,</span> <span class="n">xtb_energies</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;XTB&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/impes_40_0.png" src="../_images/impes_40_0.png" />
</div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./docs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="transition_state.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Transition state geometry optimization</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="moldyn.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Molecular dynamics</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By The eChem team<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>